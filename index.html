<!DOCTYPE html>
<html>
  <head>
    <base href="/">
    <title>Skolerruter</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <link rel="stylesheet" href="https://bootswatch.com/yeti/bootstrap.min.css">
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>


    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="/manifest.json">

    <!-- Polyfill(s) for older browsers -->
    <script src="node_modules/core-js/client/shim.min.js"></script>

    <script src="node_modules/zone.js/dist/zone.js"></script>
    <script src="node_modules/reflect-metadata/Reflect.js"></script>
    <script src="node_modules/systemjs/dist/system.src.js"></script>
    <script src="node_modules/file-saver/FileSaver.js"></script>

    <script src="systemjs.config.js"></script>
    <script>
      System.import('app/built/app/main').catch(function(err){ console.error(err); });
    </script>
  </head>

  <body>
    <div id="page-wrap">
    <my-app> <br><div class="loader" style="margin-left: 45%;margin-top:25%;"></div><h3 style="padding-left:1em;">Laster inn skolerutedata<h3></my-app>
  </body> 
    </div>
<script src="https://www.gstatic.com/firebasejs/3.5.3/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyBKvAHdMkcBOs-LaRfbNwjqnue_Pz9CanQ",
    authDomain: "skoleruter-1476962437581.firebaseapp.com",
    databaseURL: "https://skoleruter-1476962437581.firebaseio.com",
    storageBucket: "skoleruter-1476962437581.appspot.com",
    messagingSenderId: "27318779670"
  };
  firebase.initializeApp(config);

</script>
<script>
  const messaging = firebase.messaging();

  messaging.onTokenRefresh(function() {
    messaging.getToken()
    .then(function(refreshedToken) {
      console.log('Token refreshed.');
    })
    .catch(function(err) {
      console.log('Unable to retrieve refreshed token ', err);
    });
  });

  function requestPermission() {
    console.log('Requesting permission...');
    messaging.requestPermission()
    .then(function() {
      console.log('Notification permission granted.');
       messaging.getToken()
    .then(function(currentToken) {
      console.log(currentToken);
      localStorage.setItem("token", currentToken);
      abonner(currentToken);
    })
    })
    .catch(function(err) {
      console.log('Unable to get permission to notify.', err);
    });
  }


  function abonner(currentToken){
    "use strict"
      let topics_lagret = localStorage.getItem("topicsListe");
      let topics = JSON.parse(topics_lagret);
      console.log(topics);
      for (let i = 0; i < topics.length; i++){
      let data = null;
      
      let xhr = new XMLHttpRequest();
      xhr.addEventListener("readystatechange", function () {
      if (this.readyState === 4) {
        console.log(this.responseText);
      }
      });
      let body = {};
        let url = "https://iid.googleapis.com/iid/v1/"+currentToken+"/rel/topics/"+topics[i];
        xhr.open("POST", url);
        xhr.setRequestHeader("authorization", "key=AAAABlxTfxY:APA91bGE3sa09zqpwyWQAVfBJI8J0RdZSIVJul3N-y1hMJqAoKngwjC_El3rEuH4_-S2gOxKcdAF67HHhGK7pAWJrhyt8JthJGm_QN6JdXTBow62nYodgFvLncfSniwtBinBgIPLaKpT");
        xhr.setRequestHeader("content-type", "application/json");
        xhr.send(data);
      }
      let abonnerer ="true";
      localStorage.setItem("abonnerer", abonnerer);
   }

  function deleteToken() {
    messaging.getToken()
    .then(function(currentToken) {
      messaging.deleteToken(currentToken)
      .then(function() {
        console.log('Token deleted.');
        let abonnerer ="";
      localStorage.setItem("abonnerer", abonnerer);
      })
      .catch(function(err) {
        console.log('Unable to delete token. ', err);
      });
    })
    .catch(function(err) {
      console.log('Error retrieving Instance ID token. ', err);
    });
  }

</script>


</html>
